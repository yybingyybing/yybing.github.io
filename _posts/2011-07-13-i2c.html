---
title: I2C调试小结
tags: C语言 设备 硬件 i2c
categories: driver
---

<p class="p0" style="text-align:left;"><span style="font-family:&#39;宋体&#39;;font-size:10.5pt;">文章首发：http://user.qzone.qq.com/276546441/blog/1303712793</span></p>
<p class="p0" style="text-align:left;"><span style="font-family:&#39;宋体&#39;;font-size:10.5pt;"><br></span></p>
<p class="p0" style="text-align:left;"><span style="font-family:&#39;宋体&#39;;font-size:10.5pt;">1、</span><span style="font-family:&#39;宋体&#39;;font-size:10.5pt;">硬件部分</span></p>
<p class="p0" style="text-indent:21pt;text-align:left;"><span style="font-family:&#39;宋体&#39;;font-size:10.5pt;">I2C<span
		 style="font-family:&#39;宋体&#39;;">物理组成上，只有两根线，一根时钟线，一根数据线，线的具体位置原理图都为标注的，找</span><span style="font-family:&#39;Times New Roman&#39;;">ISCL</span><span
		 style="font-family:&#39;宋体&#39;;">和</span><span style="font-family:&#39;Times New Roman&#39;;">ISDA</span><span
		 style="font-family:&#39;宋体&#39;;">管脚即可。</span><span style="font-family:&#39;Times New Roman&#39;;">I2C</span><span
		 style="font-family:&#39;宋体&#39;;">的时钟线不像一般总线的时钟，时刻都存在，只有当总线上有数据发送时，才会产生时钟信号；数据线在没有数据传送时，一直为高电平，故如果发送数据时发现返回总线忙的错误，原因一般为数据线上电平被拉低了。</span></span>
		 <span
	 style="font-family:&#39;宋体&#39;;font-size:10.5pt;"></span></p>

<p class="p0" style="text-indent:21pt;text-align:left;"><span style="font-family:&#39;宋体&#39;;font-size:10.5pt;">调试<span
		 style="font-family:&#39;Times New Roman&#39;;">I2C</span><span style="font-family:&#39;宋体&#39;;">信号时，示波器需要设置为触发式，如果需要查看发送数据是否正确，最好用两个探头同时测时钟与数据信号，这样可以方便看出捕获的数据值。</span></span></p>
<p class="p0" style="text-indent:21pt;text-align:left;"><br><span style="font-family:&#39;宋体&#39;;font-size:10.5pt;"></span><span
	 style="font-family:&#39;宋体&#39;;font-size:10.5pt;"></span></p>
<p class="p0" style="text-indent:21pt;text-align:left;"><span style="font-family:&#39;宋体&#39;;font-size:10.5pt;"></span></p>
<p class="p0" style="text-align:left;"><span style="font-family:&#39;宋体&#39;;font-size:10.5pt;">2、</span><span style="font-family:&#39;宋体&#39;;font-size:10.5pt;">软件部分</span><span
	 style="font-family:&#39;宋体&#39;;font-size:10.5pt;"></span></p>
<p class="p0" style="text-indent:21pt;text-align:left;"><span style="font-family:&#39;宋体&#39;;font-size:10.5pt;">硬件了解清楚，便需要注意软件部分了。软件部分分为驱动程序与应用程序。接下来我们分别描述。</span></p>
<p class="p0" style="text-indent:21pt;text-align:left;"><br><span style="font-family:&#39;宋体&#39;;font-size:10.5pt;"></span><span
	 style="font-family:&#39;宋体&#39;;font-size:10.5pt;"></span></p>
<p class="p0" style="text-indent:21pt;text-align:left;"><span style="font-family:&#39;宋体&#39;;font-size:10.5pt;"></span></p>
<p class="p0" style="text-indent:21pt;text-align:left;"><span style="font-family:&#39;宋体&#39;;font-size:10.5pt;">2.1&nbsp;<span
		 style="font-family:&#39;宋体&#39;;">驱动程序</span></span><span style="font-family:&#39;宋体&#39;;font-size:10.5pt;"></span></p>
<p class="p0" style="text-indent:21pt;text-align:left;"><span style="font-family:&#39;宋体&#39;;font-size:10.5pt;">由于操作系统的存在，应用软件和硬件打交道需要通过驱动来进行。笔者使用的设备都基于<span
		 style="font-family:&#39;Times New Roman&#39;;">Linux</span><span style="font-family:&#39;宋体&#39;;">系统，故本文描述内容基于</span><span
		 style="font-family:&#39;Times New Roman&#39;;">Linux</span><span style="font-family:&#39;宋体&#39;;">系统。</span></span><span
	 style="font-family:&#39;宋体&#39;;font-size:10.5pt;"></span></p>
<p class="p0" style="text-indent:21pt;text-align:left;"><span style="font-family:&#39;宋体&#39;;font-size:10.5pt;">驱动部分需要了解两个方面内容：<span
		 style="font-family:&#39;Times New Roman&#39;;">I2C</span><span style="font-family:&#39;宋体&#39;;">设备体系结构和</span><span
		 style="font-family:&#39;Times New Roman&#39;;">I2C</span><span style="font-family:&#39;宋体&#39;;">协议含义。</span></span><span
	 style="font-family:&#39;宋体&#39;;font-size:10.5pt;"></span></p>
<p class="p0" style="text-indent:21pt;text-align:left;"><span style="font-family:&#39;宋体&#39;;font-size:10.5pt;">驱动一般分为总线驱动与设备驱动。由于<span
		 style="font-family:&#39;Times New Roman&#39;;">Linux</span><span style="font-family:&#39;宋体&#39;;">内核是开源的，所有有人都可以定制内核来适应自己的硬件系统来使用。所以一般情况下，我们要写的设备的总线驱动最新内核中都会包含的，有兴趣的可以通过阅读内核代码来了解其工作原理。</span></span><span
	 style="font-family:&#39;宋体&#39;;font-size:10.5pt;"></span></p>
<p class="p0" style="text-indent:21pt;text-align:left;"><span style="font-family:&#39;宋体&#39;;font-size:10.5pt;"></span></p>
<p class="p0" style="text-indent:21pt;text-align:left;"><span style="font-family:&#39;宋体&#39;;font-size:10.5pt;">设备驱动只需按总线驱动的要求构造数据结构，实现操作函数注册设备即可。代码结构可以参考已有的驱动代码（附录中提供了一种简单协议的<span
		 style="font-family:&#39;Times New Roman&#39;;">I2C</span><span style="font-family:&#39;宋体&#39;;">驱动代码，有兴趣可以参考一下），复用已有框架代码，实现自己的设备对应的协议便可以。</span></span><span
	 style="font-family:&#39;宋体&#39;;font-size:10.5pt;"></span></p>
<p><span style="font-family:&#39;宋体&#39;;font-size:10.5pt;">I2C<span style="font-family:&#39;宋体&#39;;">直观来说只是通信通道，芯片需要设置寄存器数据时，可以自定义通信协议，应用程序按照协议规定组织好数据发给</span><span
		 style="font-family:&#39;Times New Roman&#39;;">I2C</span><span style="font-family:&#39;宋体&#39;;">总线即可。协议制定时，不同芯片的协议有可能不同，常见的协议是&nbsp;</span><span
		 style="font-family:&#39;Times New Roman&#39;;">|&nbsp;I2C</span><span style="font-family:&#39;宋体&#39;;">地址&nbsp;</span><span
		 style="font-family:&#39;Times New Roman&#39;;">|&nbsp;</span><span style="font-family:&#39;宋体&#39;;">寄存器地址&nbsp;</span><span
		 style="font-family:&#39;Times New Roman&#39;;">|&nbsp;</span><span style="font-family:&#39;宋体&#39;;">节数据&nbsp;</span><span
		 style="font-family:&#39;Times New Roman&#39;;">|</span><span style="font-family:&#39;宋体&#39;;">，这些协议在芯片手册中都会有明确说明。比如某款镜头的协议如下图：</span></span></p>
<p align="center"><img src="/static/img/0_1310526053ZVji.gif" alt=""></p>
<p align="center"><span style="font-family:Arial;font-size:10pt;">图表&nbsp;</span><span><span style="font-family:Arial;font-size:10pt;">1</span></span><span
	 style="font-family:&#39;黑体&#39;;font-size:10pt;">：</span><span style="font-family:&#39;黑体&#39;;font-size:10pt;">&nbsp;I2C<span
		 style="font-family:&#39;黑体&#39;;">写时序</span></span></p>
<p align="left"><br></p>
<p><span><span style="font-family:&#39;Times New Roman&#39;;font-size:10.5pt;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
			图表&nbsp;<span style="font-family:&#39;Times New Roman&#39;;">1</span></span></span><span style="font-family:&#39;宋体&#39;;font-size:10.5pt;">为该镜头的写操作协议（时序），由图可知，该镜头在<span
		 style="font-family:&#39;Times New Roman&#39;;">I2C</span><span style="font-family:&#39;宋体&#39;;">体系中的地址是</span><span
		 style="font-family:&#39;Times New Roman&#39;;">0xBA</span><span style="font-family:&#39;宋体&#39;;">（说白了也就是协议头），设备地址为了区分读写操作，一个字节中的前七位为设备地址，当最后一位是</span><span
		 style="font-family:&#39;Times New Roman&#39;;">0</span><span style="font-family:&#39;宋体&#39;;">时为写操作，值是</span><span
		 style="font-family:&#39;Times New Roman&#39;;">1</span><span style="font-family:&#39;宋体&#39;;">时为读操作，紧跟着的一个字节是寄存器地址</span><span
		 style="font-family:&#39;Times New Roman&#39;;">0x09</span><span style="font-family:&#39;宋体&#39;;">，然后是写入寄存器的两字节值</span><span
		 style="font-family:&#39;Times New Roman&#39;;">0000&nbsp;0010&nbsp;1000&nbsp;0100</span><span style="font-family:&#39;宋体&#39;;">，所以在写这镜头寄存器时给</span><span
		 style="font-family:&#39;Times New Roman&#39;;">I2C</span><span style="font-family:&#39;宋体&#39;;">总线发送的数据为</span><span
		 style="font-family:&#39;Times New Roman&#39;;">0xBA&nbsp;0x09&nbsp;0x02&nbsp;0x84</span><span style="font-family:&#39;宋体&#39;;">，发送完后，镜头解析完命令便把地址为</span><span
		 style="font-family:&#39;Times New Roman&#39;;">0x09</span><span style="font-family:&#39;宋体&#39;;">寄存器的值设置为</span><span
		 style="font-family:&#39;Times New Roman&#39;;">0x0284</span><span style="font-family:&#39;宋体&#39;;">。</span></span></p>
<p align="center"><img src="/static/img/0_1310526134WKQl.gif" alt=""></p>
<p align="center"><span style="font-family:Arial;font-size:10pt;">图表&nbsp;</span><span><span style="font-family:Arial;font-size:10pt;">2</span></span><span
	 style="font-family:&#39;黑体&#39;;font-size:10pt;">：</span><span style="font-family:&#39;黑体&#39;;font-size:10pt;">I2C<span
		 style="font-family:&#39;黑体&#39;;">读时序</span></span></p>
<p class="p0" style="text-indent:21pt;text-align:left;"><span><span style="font-family:&#39;Times New Roman&#39;;font-size:10.5pt;">图表&nbsp;<span
			 style="font-family:&#39;Times New Roman&#39;;">2</span></span></span><span style="font-family:&#39;宋体&#39;;font-size:10.5pt;">为该镜头的读操作协议（时序），进行读操作之前需要先写入要读的寄存器地址，这便是<span
		 style="font-family:&#39;Times New Roman&#39;;">0xBA&nbsp;0x09</span><span style="font-family:&#39;宋体&#39;;">的作用，然后直接读操作，</span><span
		 style="font-family:&#39;Times New Roman&#39;;">0xBB</span><span style="font-family:&#39;宋体&#39;;">便是对</span><span
		 style="font-family:&#39;Times New Roman&#39;;">0xBA</span><span style="font-family:&#39;宋体&#39;;">地址的</span><span
		 style="font-family:&#39;Times New Roman&#39;;">I2C</span><span style="font-family:&#39;宋体&#39;;">设备进行读操作，读出两字节内容，便是</span><span
		 style="font-family:&#39;Times New Roman&#39;;">0x09</span><span style="font-family:&#39;宋体&#39;;">对应的寄存器值。</span></span><span
	 style="font-family:&#39;宋体&#39;;font-size:10.5pt;"></span></p>
<p class="p0" style="text-indent:21pt;text-align:left;"><span style="font-family:&#39;宋体&#39;;font-size:10.5pt;"></span></p>
<p><span style="font-family:&#39;宋体&#39;;font-size:10.5pt;">而另一款镜头的协议则有些复杂。见下图。</span></p>
<p align="center"><img src="/static/img/0_1310526194l8MO.gif" alt=""></p>
<p align="center"><span style="font-family:Arial;font-size:10pt;">图表&nbsp;</span><span><span style="font-family:Arial;font-size:10pt;">3</span></span><span
	 style="font-family:&#39;黑体&#39;;font-size:10pt;">：写时序</span></p>
<p class="p0" style="text-indent:21pt;"><span style="font-family:&#39;宋体&#39;;font-size:10.5pt;">这个协议的制定格式为</span><span
	 style="font-family:&#39;宋体&#39;;font-size:10.5pt;">|&nbsp;<span style="font-family:&#39;宋体&#39;;">设备地址&nbsp;</span><span
		 style="font-family:&#39;Times New Roman&#39;;">|&nbsp;44</span><span style="font-family:&#39;宋体&#39;;">字节数据&nbsp;</span><span
		 style="font-family:&#39;Times New Roman&#39;;">|</span><span style="font-family:&#39;宋体&#39;;">。</span><span style="font-family:&#39;Times New Roman&#39;;">44</span><span
		 style="font-family:&#39;宋体&#39;;">字节数据的协议有明确的说明文档，只要按照文档说明组织内容即可达到自己想要的操作。</span></span></p>
<p class="p0" style="text-indent:21pt;"><br><span style="font-family:&#39;宋体&#39;;font-size:10.5pt;"></span><span style="font-family:&#39;宋体&#39;;font-size:10.5pt;"></span></p>
<p class="p0" style="text-indent:21pt;text-align:left;"><span style="font-family:&#39;宋体&#39;;font-size:10.5pt;"></span></p>
<p class="p0" style="text-indent:21pt;text-align:left;"><span style="font-family:&#39;宋体&#39;;font-size:10.5pt;">2.2&nbsp;<span
		 style="font-family:&#39;宋体&#39;;">应用程序</span></span><span style="font-family:&#39;宋体&#39;;font-size:10.5pt;"></span></p>
<p><span style="font-family:&#39;宋体&#39;;font-size:10.5pt;">应用程序主要通过驱动的<span style="font-family:&#39;Times New Roman&#39;;">IOCONTRL</span><span
		 style="font-family:&#39;宋体&#39;;">接口操作</span><span style="font-family:&#39;Times New Roman&#39;;">I2C</span><span
		 style="font-family:&#39;宋体&#39;;">，按手册提供的协议说明发送命令即可，可以参考附录中应用程序部分代码。</span></span></p>
<p><span style="font-family:&#39;宋体&#39;;font-size:10.5pt;"><span style="font-family:&#39;宋体&#39;;">&nbsp;&nbsp;&nbsp;
			3 附录<br></span></span></p>
<p></p>
<pre><code class="language-cpp hljs"><ol class="hljs-ln hundred" style="width:1218px"><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="1"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	<span class="hljs-number">3.1</span> 简单I2C协议驱动代码</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="2"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="3"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;dev_i2c.h&gt;</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="4"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;linux/config.h&gt;</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="5"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;linux/module.h&gt;</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="6"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;linux/init.h&gt;</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="7"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;linux/fs.h&gt;           /* everything... */</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="8"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;linux/cdev.h&gt;</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="9"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;linux/mm.h&gt;</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="10"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;linux/i2c.h&gt;</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="11"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;linux/kernel.h&gt;       /* printk() */</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="12"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;linux/slab.h&gt;         /* kmalloc() */</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="13"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;asm/uaccess.h&gt;        /* copy_*_user */</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="14"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="15"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="16"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	<span class="hljs-keyword">static</span> <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">short</span> gI2C_curAddr;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="17"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="18"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	<span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> {</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="19"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="20"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-keyword">int</span> devAddr;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="21"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="22"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">i2c_client</span> <span class="hljs-title">client</span>;</span>   <span class="hljs-comment">//!&lt; Data structure containing general access routines.</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="23"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">i2c_driver</span> <span class="hljs-title">driver</span>;</span>   <span class="hljs-comment">//!&lt; Data structure containing information specific to each client.</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="24"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="25"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-keyword">char</span> name[<span class="hljs-number">20</span>];</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="26"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-keyword">int</span> nameSize;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="27"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-keyword">int</span> users;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="28"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="29"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	} I2C_Obj;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="30"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="31"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	<span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> {</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="32"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="33"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">cdev</span> <span class="hljs-title">cdev</span>;</span>             <span class="hljs-comment">/* Char device structure    */</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="34"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-keyword">int</span>     major;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="35"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">semaphore</span> <span class="hljs-title">semLock</span>;</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="36"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="37"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  I2C_Obj *pObj[I2C_DEV_MAX_ADDR];</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="38"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="39"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-keyword">uint8_t</span> reg[I2C_TRANSFER_BUF_SIZE_MAX];</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="40"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-keyword">uint8_t</span> buffer[I2C_TRANSFER_BUF_SIZE_MAX*<span class="hljs-number">4</span>];</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="41"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="42"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	} I2C_Dev;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="43"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="44"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	I2C_Dev gI2C_dev;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="45"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="46"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">I2C_detectClient</span><span class="hljs-params">(struct i2c_adapter *adapter, <span class="hljs-keyword">int</span> address)</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="47"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	{</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="48"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    I2C_Obj *pObj;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="49"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">i2c_client</span> *<span class="hljs-title">client</span>;</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="50"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    <span class="hljs-keyword">int</span> err = <span class="hljs-number">0</span>;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="51"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="52"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    <span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> I2C_DEBUG</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="53"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    printk(KERN_INFO <span class="hljs-string">"I2C: I2C_detectClient() at address %x ...\n"</span>, address);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="54"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    <span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="55"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	        </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="56"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    <span class="hljs-keyword">if</span>(address &gt; I2C_DEV_MAX_ADDR) {</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="57"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	      printk( KERN_ERR <span class="hljs-string">"I2C: ERROR: Invalid device address %x\n"</span>, address);        </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="58"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	      <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="59"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    }</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="60"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	      </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="61"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    pObj = gI2C_dev.pObj[address];</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="62"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    <span class="hljs-keyword">if</span>(pObj==<span class="hljs-literal">NULL</span>) {</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="63"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	      printk( KERN_ERR <span class="hljs-string">"I2C: ERROR: Object not found for address %x\n"</span>, address);    </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="64"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	      <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="65"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    }</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="66"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="67"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    client = &amp;pObj-&gt;client;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="68"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="69"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    <span class="hljs-keyword">if</span>(client-&gt;adapter)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="70"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	      <span class="hljs-keyword">return</span> -EBUSY;  <span class="hljs-comment">/* our client is already attached */</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="71"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="72"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    <span class="hljs-built_in">memset</span>(client, <span class="hljs-number">0x00</span>, <span class="hljs-keyword">sizeof</span>(struct i2c_client));</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="73"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    client-&gt;addr = pObj-&gt;devAddr;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="74"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    client-&gt;adapter = adapter;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="75"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    client-&gt;driver = &amp;pObj-&gt;driver;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="76"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="77"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    <span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> I2C_DEBUG</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="78"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    printk(KERN_INFO <span class="hljs-string">"I2C: i2c_attach_client() ...\n"</span>);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="79"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    <span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="80"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="81"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    <span class="hljs-keyword">if</span>((err = i2c_attach_client(client)))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="82"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    {</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="83"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	        printk( KERN_ERR <span class="hljs-string">"I2C: ERROR: Couldn't attach %s (address=%x)\n"</span>, pObj-&gt;name, pObj-&gt;devAddr);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="84"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	        client-&gt;adapter = <span class="hljs-literal">NULL</span>;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="85"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	        <span class="hljs-keyword">return</span> err;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="86"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    }</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="87"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="88"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    <span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> I2C_DEBUG</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="89"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    printk( KERN_INFO <span class="hljs-string">"I2C: %s client registered at address %x !\n"</span>, pObj-&gt;name, pObj-&gt;devAddr );</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="90"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    <span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="91"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="92"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="93"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	}</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="94"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="95"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">I2C_detachClient</span><span class="hljs-params">(struct i2c_client *client)</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="96"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	{</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="97"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    <span class="hljs-keyword">int</span> err;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="98"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="99"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    <span class="hljs-keyword">if</span>(!client-&gt;adapter)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="100"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	        <span class="hljs-keyword">return</span> -ENODEV; <span class="hljs-comment">/* our client isn't attached */</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="101"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="102"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    <span class="hljs-keyword">if</span>((err = i2c_detach_client(client))) {</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="103"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	        printk( KERN_ERR <span class="hljs-string">"Client deregistration failed (address=%x), client not detached.\n"</span>, client-&gt;addr);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="104"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	        <span class="hljs-keyword">return</span> err;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="105"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    }</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="106"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="107"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    client-&gt;adapter = <span class="hljs-literal">NULL</span>;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="108"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="109"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="110"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	}</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="111"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="112"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">I2C_attachAdapter</span><span class="hljs-params">(struct i2c_adapter *adapter)</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="113"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	{</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="114"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    <span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> I2C_DEBUG</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="115"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    printk(KERN_INFO <span class="hljs-string">"I2C: I2C_attachAdapter() ...\n"</span>);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="116"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    <span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="117"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="118"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    <span class="hljs-keyword">return</span> I2C_detectClient(adapter, gI2C_curAddr);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="119"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	}</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="120"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="121"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	<span class="hljs-function"><span class="hljs-keyword">void</span> *<span class="hljs-title">I2C_create</span><span class="hljs-params">(<span class="hljs-keyword">int</span> devAddr)</span> </span>{</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="122"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="123"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    <span class="hljs-keyword">int</span> ret;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="124"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">i2c_driver</span> *<span class="hljs-title">driver</span>;</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="125"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">i2c_client</span> *<span class="hljs-title">client</span> = <span class="hljs-title">client</span>;</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="126"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="127"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    I2C_Obj *pObj;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="128"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="129"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    <span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> I2C_DEBUG</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="130"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    printk(KERN_INFO <span class="hljs-string">"I2C: Driver registration in progress for address %x...\n"</span>, devAddr);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="131"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    <span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="132"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="133"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    devAddr &gt;&gt;= <span class="hljs-number">1</span>;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="134"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="135"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    <span class="hljs-keyword">if</span>(devAddr&gt;I2C_DEV_MAX_ADDR)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="136"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	      <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="137"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	   </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="138"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    <span class="hljs-keyword">if</span>(gI2C_dev.pObj[devAddr]!=<span class="hljs-literal">NULL</span>) {</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="139"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	      <span class="hljs-comment">// already allocated, increment user count, and return the allocated handle</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="140"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	      </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="141"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	      gI2C_dev.pObj[devAddr]-&gt;users++;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="142"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	      </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="143"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	      <span class="hljs-keyword">return</span> gI2C_dev.pObj[devAddr];</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="144"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    }</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="145"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="146"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    pObj = (<span class="hljs-keyword">void</span>*)kmalloc( <span class="hljs-keyword">sizeof</span>(I2C_Obj), GFP_KERNEL);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="147"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="148"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    gI2C_dev.pObj[devAddr] = pObj;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="149"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="150"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    <span class="hljs-built_in">memset</span>(pObj, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(I2C_Obj));</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="151"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="152"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    pObj-&gt;client.adapter = <span class="hljs-literal">NULL</span>;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="153"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    pObj-&gt;users++;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="154"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="155"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    pObj-&gt;devAddr = devAddr;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="156"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="157"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    gI2C_curAddr = pObj-&gt;devAddr;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="158"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="159"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    driver = &amp;pObj-&gt;driver;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="160"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="161"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    pObj-&gt;nameSize=<span class="hljs-number">0</span>;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="162"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    pObj-&gt;name[pObj-&gt;nameSize++] = <span class="hljs-string">'I'</span>;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="163"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    pObj-&gt;name[pObj-&gt;nameSize++] = <span class="hljs-string">'2'</span>;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="164"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    pObj-&gt;name[pObj-&gt;nameSize++] = <span class="hljs-string">'C'</span>;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="165"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    pObj-&gt;name[pObj-&gt;nameSize++] = <span class="hljs-string">'_'</span>;   </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="166"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    pObj-&gt;name[pObj-&gt;nameSize++] = <span class="hljs-string">'A'</span> + ((pObj-&gt;devAddr &gt;&gt; <span class="hljs-number">0</span>) &amp; <span class="hljs-number">0xF</span>);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="167"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    pObj-&gt;name[pObj-&gt;nameSize++] = <span class="hljs-string">'B'</span> + ((pObj-&gt;devAddr &gt;&gt; <span class="hljs-number">4</span>) &amp; <span class="hljs-number">0xF</span>);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="168"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    pObj-&gt;name[pObj-&gt;nameSize++] = <span class="hljs-number">0</span>;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="169"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="170"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    driver-&gt;driver.name = pObj-&gt;name;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="171"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    driver-&gt;id = I2C_DRIVERID_MISC;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="172"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    driver-&gt;attach_adapter = I2C_attachAdapter;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="173"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    driver-&gt;detach_client = I2C_detachClient;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="174"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="175"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    <span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> I2C_DEBUG</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="176"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    printk(KERN_INFO <span class="hljs-string">"I2C: i2c_add_driver() ...\n"</span>);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="177"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    <span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="178"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="179"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    <span class="hljs-keyword">if</span>((ret = i2c_add_driver(driver)))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="180"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    {</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="181"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	        printk( KERN_ERR <span class="hljs-string">"I2C: ERROR: Driver registration failed (address=%x), module not inserted.\n"</span>, pObj-&gt;devAddr);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="182"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    }</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="183"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="184"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    <span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> I2C_DEBUG</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="185"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    printk(KERN_INFO <span class="hljs-string">"I2C: Driver registration successful (address=%x)\n"</span>, pObj-&gt;devAddr);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="186"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    <span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="187"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="188"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    <span class="hljs-keyword">if</span>(ret&lt;<span class="hljs-number">0</span>) {</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="189"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="190"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	      gI2C_dev.pObj[pObj-&gt;devAddr] = <span class="hljs-literal">NULL</span>;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="191"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="192"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	      kfree(pObj);    </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="193"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="194"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	      <span class="hljs-keyword">return</span> <span class="hljs-literal">NULL</span>;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="195"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    }</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="196"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="197"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    <span class="hljs-keyword">return</span> pObj;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="198"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	}</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="199"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="200"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">I2C_delete</span><span class="hljs-params">(I2C_Obj *pObj)</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="201"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	{</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="202"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-keyword">if</span>(pObj==<span class="hljs-literal">NULL</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="203"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="204"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="205"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  pObj-&gt;users--;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="206"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="207"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-keyword">if</span>(pObj-&gt;users&lt;=<span class="hljs-number">0</span>) {</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="208"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    <span class="hljs-keyword">if</span>(pObj-&gt;client.adapter!=<span class="hljs-literal">NULL</span>) {</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="209"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	      <span class="hljs-keyword">if</span>(i2c_del_driver(&amp;pObj-&gt;driver))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="210"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	      printk(KERN_ERR <span class="hljs-string">"I2C: ERROR: Driver remove failed (address=%x), module not removed.\n"</span>, pObj-&gt;devAddr);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="211"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="212"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	      pObj-&gt;client.adapter = <span class="hljs-literal">NULL</span>;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="213"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="214"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	      gI2C_dev.pObj[pObj-&gt;devAddr] = <span class="hljs-literal">NULL</span>;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="215"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="216"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	      kfree(pObj);    </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="217"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    }</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="218"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  }</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="219"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="220"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="221"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	}</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="222"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="223"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">I2C_read</span><span class="hljs-params">(I2C_Obj *pObj, <span class="hljs-keyword">uint8_t</span> *reg, <span class="hljs-keyword">uint8_t</span> *buffer, <span class="hljs-keyword">uint8_t</span> count, <span class="hljs-keyword">uint8_t</span> dataSize)</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="224"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	{</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="225"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-keyword">uint8_t</span> i;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="226"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-keyword">int</span> err;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="227"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">i2c_client</span> *<span class="hljs-title">client</span>;</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="228"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">		<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">i2c_msg</span> <span class="hljs-title">msg</span>[1];</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="229"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">		<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> data[<span class="hljs-number">1</span>];</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="230"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="231"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-keyword">if</span>(pObj==<span class="hljs-literal">NULL</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="232"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    <span class="hljs-keyword">return</span> -ENODEV;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="233"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="234"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  client = &amp;pObj-&gt;client;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="235"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-keyword">if</span>(!client-&gt;adapter)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="236"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    <span class="hljs-keyword">return</span> -ENODEV;  </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="237"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="238"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-keyword">if</span>(dataSize&lt;=<span class="hljs-number">0</span>||dataSize&gt;<span class="hljs-number">4</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="239"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="240"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="241"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>; i&lt;count; i++) {</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="242"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">			msg-&gt;addr  = client-&gt;addr;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="243"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">			msg-&gt;flags = <span class="hljs-number">0</span>;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="244"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">			msg-&gt;len   = <span class="hljs-number">1</span>;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="245"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">			msg-&gt;buf   = data;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="246"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">			data[<span class="hljs-number">0</span>]    = reg[i];</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="247"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">			err = i2c_transfer(client-&gt;adapter, msg, <span class="hljs-number">1</span>);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="248"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">			<span class="hljs-keyword">if</span>(err&lt;<span class="hljs-number">0</span>) {</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="249"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">			  printk( KERN_ERR <span class="hljs-string">" i2c_transfer(0x%x, %x)\n"</span>, msg-&gt;addr, msg-&gt;buf[<span class="hljs-number">0</span>]);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="250"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">			}</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="251"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="252"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">			<span class="hljs-keyword">if</span> (err &gt;= <span class="hljs-number">0</span>) </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="253"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">			{</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="254"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">				msg-&gt;flags = I2C_M_RD;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="255"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	      msg-&gt;len   = dataSize;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="256"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">				err = i2c_transfer(client-&gt;adapter, msg, <span class="hljs-number">1</span>);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="257"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">				<span class="hljs-keyword">if</span> (err &gt;= <span class="hljs-number">0</span>) </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="258"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">				{</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="259"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">				  <span class="hljs-keyword">if</span>(dataSize==<span class="hljs-number">1</span>) {</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="260"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  				buffer[i] = data[<span class="hljs-number">0</span>];</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="261"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  		  } <span class="hljs-keyword">else</span> </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="262"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  		  <span class="hljs-keyword">if</span>(dataSize==<span class="hljs-number">2</span>) {</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="263"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  		    buffer[<span class="hljs-number">2</span>*i]   = data[<span class="hljs-number">1</span>];</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="264"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  		    buffer[<span class="hljs-number">2</span>*i+<span class="hljs-number">1</span>] = data[<span class="hljs-number">0</span>];  		    </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="265"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  		  }</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="266"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">				}</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="267"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">			}</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="268"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    <span class="hljs-keyword">if</span> (err&lt;<span class="hljs-number">0</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="269"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	      <span class="hljs-keyword">return</span> -ENODEV;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="270"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  }</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="271"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="272"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="273"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	}</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="274"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="275"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">I2C_write</span><span class="hljs-params">(I2C_Obj *pObj, <span class="hljs-keyword">uint8_t</span> *reg, <span class="hljs-keyword">uint8_t</span> *buffer, <span class="hljs-keyword">uint8_t</span> count, <span class="hljs-keyword">uint8_t</span> dataSize)</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="276"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	{</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="277"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-keyword">uint8_t</span> i;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="278"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-keyword">int</span> err;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="279"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">i2c_client</span> *<span class="hljs-title">client</span>;</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="280"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">		<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">i2c_msg</span> <span class="hljs-title">msg</span>[1];</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="281"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">		<span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">char</span> data[<span class="hljs-number">8</span>];</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="282"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="283"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-keyword">if</span>(pObj==<span class="hljs-literal">NULL</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="284"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    <span class="hljs-keyword">return</span> -ENODEV;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="285"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="286"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  client = &amp;pObj-&gt;client;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="287"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-keyword">if</span>(!client-&gt;adapter)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="288"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    <span class="hljs-keyword">return</span> -ENODEV;  </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="289"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="290"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-keyword">if</span>(dataSize&lt;=<span class="hljs-number">0</span>||dataSize&gt;<span class="hljs-number">4</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="291"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="292"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="293"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>; i&lt;count; i++) {</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="294"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="295"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    msg-&gt;addr = client-&gt;addr;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="296"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">			msg-&gt;flags= <span class="hljs-number">0</span>;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="297"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">			msg-&gt;buf  = data;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="298"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">			</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="299"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">			data[<span class="hljs-number">0</span>] = reg[i];</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="300"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">			</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="301"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">			<span class="hljs-keyword">if</span>(dataSize==<span class="hljs-number">1</span>) {</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="302"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  		data[<span class="hljs-number">1</span>]  = buffer[i];</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="303"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  		msg-&gt;len = <span class="hljs-number">2</span>;  		</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="304"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    }	<span class="hljs-keyword">else</span>	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="305"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">			<span class="hljs-keyword">if</span>(dataSize==<span class="hljs-number">2</span>) {</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="306"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  		data[<span class="hljs-number">1</span>] = buffer[<span class="hljs-number">2</span>*i+<span class="hljs-number">1</span>];</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="307"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  		data[<span class="hljs-number">2</span>] = buffer[<span class="hljs-number">2</span>*i];</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="308"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  		msg-&gt;len = <span class="hljs-number">3</span>;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="309"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">			} </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="310"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">			err = i2c_transfer(client-&gt;adapter, msg, <span class="hljs-number">1</span>);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="311"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    <span class="hljs-keyword">if</span>( err &lt; <span class="hljs-number">0</span> )</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="312"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	      <span class="hljs-keyword">return</span> err;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="313"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  }</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="314"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="315"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="316"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	}</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="317"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="318"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">I2C_devOpen</span><span class="hljs-params">(struct inode *inode, struct file *filp)</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="319"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	{</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="320"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-keyword">int</span> minor, major;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="321"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="322"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  minor = iminor(inode);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="323"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  major = imajor(inode);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="324"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="325"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	<span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> I2C_DEBUG</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="326"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  printk(KERN_INFO <span class="hljs-string">"I2C: I2C_devOpen()   , %4d, %2d \n"</span>, major, minor);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="327"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="328"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="329"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  filp-&gt;private_data = <span class="hljs-literal">NULL</span>;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="330"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="331"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;                <span class="hljs-comment">/* success */</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="332"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	}</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="333"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="334"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">I2C_devRelease</span><span class="hljs-params">(struct inode *inode, struct file *filp)</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="335"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	{</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="336"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  I2C_Obj *pObj;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="337"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="338"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  pObj = (I2C_Obj *)filp-&gt;private_data;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="339"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="340"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-keyword">if</span>(pObj==<span class="hljs-literal">NULL</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="341"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="342"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="343"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	<span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> I2C_DEBUG</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="344"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  printk(KERN_INFO <span class="hljs-string">"I2C: I2C_devRelease(), %x, %d \n"</span>, pObj-&gt;devAddr, pObj-&gt;users);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="345"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="346"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="347"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  I2C_delete(pObj);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="348"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="349"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="350"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	}</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="351"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="352"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">I2C_devIoctl</span><span class="hljs-params">(struct inode *inode, struct file *filp, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">int</span> cmd, <span class="hljs-keyword">unsigned</span> <span class="hljs-keyword">long</span> arg)</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="353"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	{</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="354"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  I2C_Obj *pObj;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="355"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-keyword">int</span> status=<span class="hljs-number">0</span>;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="356"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  I2C_TransferPrm transferPrm;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="357"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="358"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  pObj = (I2C_Obj *)filp-&gt;private_data;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="359"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="360"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	<span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> I2C_DEBUG</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="361"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  printk(KERN_INFO <span class="hljs-string">"I2C: I2C_devIoctl() \n"</span>);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="362"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="363"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="364"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-keyword">if</span>(!I2C_IOCTL_CMD_IS_VALID(cmd))</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="365"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="366"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="367"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  cmd = I2C_IOCTL_CMD_GET(cmd);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="368"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="369"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  down_interruptible(&amp;gI2C_dev.semLock);      </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="370"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="371"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-keyword">switch</span>(cmd)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="372"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  {</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="373"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    <span class="hljs-keyword">case</span> I2C_CMD_SET_DEV_ADDR:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="374"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	      filp-&gt;private_data = I2C_create(arg);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="375"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	      <span class="hljs-keyword">if</span>(filp-&gt;private_data==<span class="hljs-literal">NULL</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="376"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	        status = <span class="hljs-number">-1</span>;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="377"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	      <span class="hljs-keyword">break</span>;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="378"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	      </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="379"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    <span class="hljs-keyword">case</span> I2C_CMD_WRITE:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="380"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	      </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="381"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	      status = copy_from_user(&amp;transferPrm, (<span class="hljs-keyword">void</span> *)arg, <span class="hljs-keyword">sizeof</span>(transferPrm));</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="382"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	      <span class="hljs-keyword">if</span>(status==<span class="hljs-number">0</span>) {</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="383"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	        status = copy_from_user(gI2C_dev.reg, transferPrm.reg, transferPrm.count);  </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="384"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	        status |= copy_from_user(gI2C_dev.buffer, transferPrm.value, transferPrm.count*transferPrm.dataSize);  </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="385"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	        <span class="hljs-keyword">if</span>(status==<span class="hljs-number">0</span>) {</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="386"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	          status = I2C_write(pObj, gI2C_dev.reg, gI2C_dev.buffer, transferPrm.count, transferPrm.dataSize);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="387"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	        }</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="388"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	      }</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="389"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	            </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="390"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	      <span class="hljs-keyword">break</span>;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="391"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    <span class="hljs-keyword">case</span> I2C_CMD_READ:  </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="392"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="393"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	      status = copy_from_user(&amp;transferPrm, (<span class="hljs-keyword">void</span> *)arg, <span class="hljs-keyword">sizeof</span>(transferPrm));</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="394"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	      <span class="hljs-keyword">if</span>(status==<span class="hljs-number">0</span>) {</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="395"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	        status = copy_from_user(gI2C_dev.reg, transferPrm.reg, transferPrm.count);        </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="396"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	        <span class="hljs-keyword">if</span>(status==<span class="hljs-number">0</span>) {</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="397"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	          status = I2C_read(pObj, gI2C_dev.reg, gI2C_dev.buffer, transferPrm.count, transferPrm.dataSize);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="398"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	          <span class="hljs-keyword">if</span>(status==<span class="hljs-number">0</span>) {</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="399"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	            status = copy_to_user(transferPrm.value, gI2C_dev.buffer, transferPrm.count*transferPrm.dataSize);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="400"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	          }</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="401"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	        }</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="402"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	      }</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="403"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	      </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="404"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	      <span class="hljs-keyword">break</span>;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="405"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    <span class="hljs-keyword">default</span>:</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="406"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	      status = <span class="hljs-number">-1</span>;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="407"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	      <span class="hljs-keyword">break</span>;    </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="408"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  }</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="409"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="410"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  up(&amp;gI2C_dev.semLock);      </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="411"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="412"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-keyword">return</span> status;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="413"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	}</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="414"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="415"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="416"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	<span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">file_operations</span> <span class="hljs-title">gI2C_devFileOps</span> = {</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="417"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  .owner = THIS_MODULE,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="418"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  .open = I2C_devOpen,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="419"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  .release = I2C_devRelease,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="420"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  .ioctl = I2C_devIoctl,</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="421"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	};</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="422"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="423"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">I2C_devInit</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="424"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	{</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="425"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-keyword">int</span>     result, i;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="426"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-keyword">dev_t</span>   dev = <span class="hljs-number">0</span>;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="427"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="428"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	<span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> I2C_DEBUG</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="429"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  printk(KERN_INFO <span class="hljs-string">"I2C: I2C_devInit() \n"</span>);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="430"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="431"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="432"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  result = alloc_chrdev_region(&amp;dev, <span class="hljs-number">0</span>, <span class="hljs-number">1</span>, I2C_DRV_NAME);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="433"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="434"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-keyword">if</span> (result &lt; <span class="hljs-number">0</span>) {</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="435"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    printk(KERN_WARNING <span class="hljs-string">"I2C: can't get device major num \n"</span>);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="436"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    <span class="hljs-keyword">return</span> result;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="437"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  }</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="438"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="439"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>; i&lt;I2C_DEV_MAX_ADDR; i++)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="440"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  {</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="441"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    gI2C_dev.pObj[i]=<span class="hljs-literal">NULL</span>;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="442"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  }</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="443"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="444"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  gI2C_dev.major = MAJOR(dev);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="445"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="446"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  sema_init(&amp;gI2C_dev.semLock, <span class="hljs-number">1</span>);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="447"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="448"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  cdev_init(&amp;gI2C_dev.cdev, &amp;gI2C_devFileOps);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="449"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="450"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  gI2C_dev.cdev.owner = THIS_MODULE;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="451"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  gI2C_dev.cdev.ops = &amp;gI2C_devFileOps;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="452"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="453"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  result = cdev_add(&amp;gI2C_dev.cdev, dev, <span class="hljs-number">1</span>);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="454"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="455"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-keyword">if</span> (result)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="456"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    printk(KERN_WARNING <span class="hljs-string">"I2C: Error [%d] while adding device [%s] \n"</span>, result, I2C_DRV_NAME);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="457"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="458"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  printk(KERN_INFO <span class="hljs-string">"I2C: Module install successful, device major num = %d \n"</span>, gI2C_dev.major);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="459"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="460"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-keyword">return</span> result;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="461"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	}</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="462"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="463"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	<span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">I2C_devExit</span><span class="hljs-params">(<span class="hljs-keyword">void</span>)</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="464"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	{</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="465"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-keyword">dev_t</span>   devno = MKDEV(gI2C_dev.major, <span class="hljs-number">0</span>);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="466"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="467"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	<span class="hljs-meta">#<span class="hljs-meta-keyword">ifdef</span> I2C_DEBUG</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="468"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  printk(KERN_INFO <span class="hljs-string">"I2C: I2C_devExit() \n"</span>);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="469"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	<span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="470"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="471"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  cdev_del(&amp;gI2C_dev.cdev);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="472"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="473"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  unregister_chrdev_region(devno, <span class="hljs-number">1</span>);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="474"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	}</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="475"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="476"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	<span class="hljs-number">3.2</span> 应用程序</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="477"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="478"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="479"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;drv_i2c.h&gt;</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="480"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;dev_i2c.h&gt;</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="481"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;sys/ioctl.h&gt;</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="482"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;fcntl.h&gt;</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="483"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;unistd.h&gt;</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="484"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="485"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">DRV_i2cOpen</span><span class="hljs-params">(DRV_I2cHndl *hndl, Uint8 devAddr)</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="486"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	{</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="487"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-keyword">char</span> deviceName[<span class="hljs-number">20</span>];</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="488"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  Uint32 cmd;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="489"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-keyword">int</span> status;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="490"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="491"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-built_in">sprintf</span>(deviceName, <span class="hljs-string">"/dev/%s"</span>, I2C_DRV_NAME);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="492"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="493"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  hndl-&gt;fd = open(deviceName, O_RDWR);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="494"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-keyword">if</span>(hndl-&gt;fd&lt;<span class="hljs-number">0</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="495"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    <span class="hljs-keyword">return</span> OSA_EFAIL;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="496"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="497"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  cmd = I2C_IOCTL_CMD_MAKE(I2C_CMD_SET_DEV_ADDR);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="498"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  status = ioctl(hndl-&gt;fd, cmd, devAddr);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="499"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="500"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-keyword">if</span>(status&lt;<span class="hljs-number">0</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="501"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    close(hndl-&gt;fd);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="502"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="503"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-keyword">return</span> status;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="504"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	}</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="505"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="506"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">DRV_i2cRead8</span><span class="hljs-params">(DRV_I2cHndl *hndl, Uint8 *reg, Uint8 *value, Uint8 count)</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="507"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	{</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="508"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  I2C_TransferPrm prm;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="509"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  Uint32 cmd;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="510"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-keyword">int</span> status;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="511"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="512"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  prm.dataSize = <span class="hljs-number">1</span>;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="513"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  prm.reg = reg;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="514"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  prm.count = count;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="515"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  prm.value = value;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="516"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="517"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  cmd = I2C_IOCTL_CMD_MAKE(I2C_CMD_READ);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="518"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  status = ioctl(hndl-&gt;fd, cmd, &amp;prm);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="519"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="520"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-keyword">return</span> status;  </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="521"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	}</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="522"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="523"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">DRV_i2cWrite8</span><span class="hljs-params">(DRV_I2cHndl *hndl, Uint8 *reg, Uint8 *value, Uint8 count)</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="524"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	{</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="525"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  I2C_TransferPrm prm;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="526"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  Uint32 cmd;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="527"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-keyword">int</span> status;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="528"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	   </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="529"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  prm.dataSize = <span class="hljs-number">1</span>;   </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="530"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  prm.reg = reg;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="531"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  prm.count = count;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="532"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  prm.value = value;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="533"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="534"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  cmd = I2C_IOCTL_CMD_MAKE(I2C_CMD_WRITE);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="535"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  status = ioctl(hndl-&gt;fd, cmd, &amp;prm);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="536"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="537"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-keyword">return</span> status;  </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="538"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	}</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="539"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="540"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">DRV_i2cRead16</span><span class="hljs-params">(DRV_I2cHndl *hndl, Uint8 *reg, Uint16 *value, Uint8 count)</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="541"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	{</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="542"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  I2C_TransferPrm prm;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="543"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  Uint32 cmd;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="544"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-keyword">int</span> status;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="545"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="546"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  prm.dataSize = <span class="hljs-number">2</span>;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="547"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  prm.reg = reg;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="548"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  prm.count = count;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="549"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  prm.value = value;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="550"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="551"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  cmd = I2C_IOCTL_CMD_MAKE(I2C_CMD_READ);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="552"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  status = ioctl(hndl-&gt;fd, cmd, &amp;prm);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="553"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="554"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-keyword">return</span> status;  </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="555"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	}</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="556"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="557"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">DRV_i2cWrite16</span><span class="hljs-params">(DRV_I2cHndl *hndl, Uint8 *reg, Uint16 *value, Uint8 count)</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="558"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	{</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="559"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  I2C_TransferPrm prm;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="560"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  Uint32 cmd;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="561"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-keyword">int</span> status;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="562"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	   </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="563"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  prm.dataSize = <span class="hljs-number">2</span>;   </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="564"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  prm.reg = reg;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="565"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  prm.count = count;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="566"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  prm.value = value;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="567"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="568"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  cmd = I2C_IOCTL_CMD_MAKE(I2C_CMD_WRITE);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="569"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  status = ioctl(hndl-&gt;fd, cmd, &amp;prm);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="570"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="571"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-keyword">return</span> status;  </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="572"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	}</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="573"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="574"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">DRV_i2cClose</span><span class="hljs-params">(DRV_I2cHndl *hndl)</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="575"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	{</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="576"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-keyword">return</span> close(hndl-&gt;fd);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="577"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	}</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="578"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="579"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">DRV_i2cTestShowUsage</span><span class="hljs-params">(<span class="hljs-keyword">char</span> *str)</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="580"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	{</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="581"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  OSA_printf(<span class="hljs-string">" \n"</span>);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="582"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  OSA_printf(<span class="hljs-string">" I2C Test Utility, \r\n"</span>);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="583"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  OSA_printf(<span class="hljs-string">" Usage: %s -r|-w &lt;devAddrInHex&gt; &lt;regAddrInHex&gt; &lt;regValueInHex or numRegsToReadInDec&gt; &lt;regSizeInBytes&gt;\r\n"</span>, str);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="584"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  OSA_printf(<span class="hljs-string">" \n"</span>);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="585"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="586"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	}</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="587"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="588"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">DRV_i2cTestMain</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span> **argv)</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="589"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	{</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="590"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  DRV_I2cHndl i2cHndl;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="591"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  Uint8 devAddr, numRegs;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="592"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  Bool doRead;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="593"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  Uint8 dataSize=<span class="hljs-number">1</span>;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="594"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-keyword">int</span> status, i;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="595"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="596"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-keyword">static</span> Uint8 regAddr[<span class="hljs-number">256</span>], regValue8[<span class="hljs-number">256</span>];</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="597"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-keyword">static</span> Uint16 regValue16[<span class="hljs-number">256</span>];      </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="598"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="599"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-keyword">if</span>(argc&lt;<span class="hljs-number">3</span>) {</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="600"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    DRV_i2cTestShowUsage(argv[<span class="hljs-number">0</span>]);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="601"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="602"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  }</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="603"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="604"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-keyword">if</span>(<span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">1</span>], <span class="hljs-string">"-r"</span>)==<span class="hljs-number">0</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="605"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    doRead=TRUE;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="606"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-keyword">else</span>  </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="607"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-keyword">if</span>(<span class="hljs-built_in">strcmp</span>(argv[<span class="hljs-number">1</span>], <span class="hljs-string">"-w"</span>)==<span class="hljs-number">0</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="608"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    doRead=FALSE;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="609"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-keyword">else</span> {</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="610"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    DRV_i2cTestShowUsage(argv[<span class="hljs-number">0</span>]);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="611"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;  </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="612"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  }</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="613"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="614"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  devAddr = <span class="hljs-number">0</span>;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="615"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  numRegs = <span class="hljs-number">4</span>;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="616"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  regValue8[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="617"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  regValue16[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="618"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  regAddr[<span class="hljs-number">0</span>] = <span class="hljs-number">0</span>;  </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="619"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="620"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-keyword">if</span>(argc&gt;<span class="hljs-number">2</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="621"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    devAddr = xstrtoi(argv[<span class="hljs-number">2</span>]);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="622"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="623"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-keyword">if</span>(argc&gt;<span class="hljs-number">3</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="624"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    regAddr[<span class="hljs-number">0</span>] = xstrtoi(argv[<span class="hljs-number">3</span>]);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="625"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="626"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-keyword">if</span>(argc&gt;<span class="hljs-number">5</span>) </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="627"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    dataSize = atoi(argv[<span class="hljs-number">5</span>]);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="628"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="629"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-keyword">if</span>(dataSize&gt;<span class="hljs-number">2</span> || dataSize&lt;=<span class="hljs-number">0</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="630"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    dataSize=<span class="hljs-number">1</span>;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="631"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="632"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-keyword">if</span>(argc&gt;<span class="hljs-number">4</span>) {</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="633"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    <span class="hljs-keyword">if</span>(doRead)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="634"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	      numRegs = atoi(argv[<span class="hljs-number">4</span>]);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="635"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    <span class="hljs-keyword">else</span> {</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="636"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	      <span class="hljs-keyword">if</span>(dataSize==<span class="hljs-number">1</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="637"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	        regValue8[<span class="hljs-number">0</span>] = xstrtoi(argv[<span class="hljs-number">4</span>]);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="638"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	      <span class="hljs-keyword">else</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="639"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	      <span class="hljs-keyword">if</span>(dataSize==<span class="hljs-number">2</span>)      </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="640"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	        regValue16[<span class="hljs-number">0</span>] = xstrtoi(argv[<span class="hljs-number">4</span>]);      </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="641"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    }</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="642"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  }</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="643"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="644"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-keyword">if</span>(devAddr==<span class="hljs-number">0</span>) {</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="645"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    OSA_printf(<span class="hljs-string">" I2C: Invalid device address\n"</span>);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="646"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    DRV_i2cTestShowUsage(argv[<span class="hljs-number">0</span>]);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="647"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;  </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="648"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  }</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="649"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="650"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	<span class="hljs-comment">//  OSA_printf(" I2C: Opening I2C at device address %x ...\n", devAddr);</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="651"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="652"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  status = DRV_i2cOpen(&amp;i2cHndl, devAddr);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="653"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="654"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-keyword">if</span>(status != OSA_SOK) {</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="655"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    OSA_ERROR(<span class="hljs-string">"DRV_i2cOpen(%d)"</span>, devAddr);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="656"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    <span class="hljs-keyword">return</span> status;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="657"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  }</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="658"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="659"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  <span class="hljs-keyword">if</span>(status==OSA_SOK)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="660"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  {</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="661"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    <span class="hljs-meta">#<span class="hljs-meta-keyword">if</span> 1</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="662"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    <span class="hljs-keyword">if</span>(doRead) {</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="663"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	      <span class="hljs-keyword">for</span>(i=<span class="hljs-number">1</span>; i&lt;numRegs; i++)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="664"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	        regAddr[i] = regAddr[<span class="hljs-number">0</span>]+i;</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="665"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	      </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="666"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	      <span class="hljs-keyword">if</span>(dataSize==<span class="hljs-number">1</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="667"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	        status = DRV_i2cRead8(&amp;i2cHndl, regAddr, regValue8, numRegs);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="668"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	      <span class="hljs-keyword">else</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="669"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	      <span class="hljs-keyword">if</span>(dataSize==<span class="hljs-number">2</span>)      </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="670"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	        status = DRV_i2cRead16(&amp;i2cHndl, regAddr, regValue16, numRegs);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="671"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="672"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	      OSA_printf(<span class="hljs-string">" \n"</span>);      </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="673"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	      <span class="hljs-keyword">if</span>(status==OSA_SOK) {</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="674"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	        <span class="hljs-keyword">for</span>(i=<span class="hljs-number">0</span>; i&lt;numRegs; i++) {</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="675"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	          <span class="hljs-keyword">if</span>(dataSize==<span class="hljs-number">1</span>) {</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="676"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	            OSA_printf(<span class="hljs-string">" I2C: 0x%02x = 0x%02x \n"</span>, regAddr[i], regValue8[i] );          </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="677"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	          } <span class="hljs-keyword">else</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="678"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	          <span class="hljs-keyword">if</span>(dataSize==<span class="hljs-number">2</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="679"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	            OSA_printf(<span class="hljs-string">" I2C: 0x%02x = 0x%04x \n"</span>, regAddr[i], regValue16[i] );          </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="680"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	          </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="681"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	        }</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="682"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	      } <span class="hljs-keyword">else</span> {</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="683"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	        OSA_printf(<span class="hljs-string">" I2C: Read ERROR !!!\n"</span>);          </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="684"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	      }</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="685"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	      OSA_printf(<span class="hljs-string">" \n"</span>);              </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="686"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	      </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="687"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    } <span class="hljs-keyword">else</span> {</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="688"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	      OSA_printf(<span class="hljs-string">" \n"</span>);              </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="689"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	          </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="690"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	      <span class="hljs-keyword">if</span>(dataSize==<span class="hljs-number">1</span>) {   </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="691"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="692"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	        status = DRV_i2cWrite8(&amp;i2cHndl, regAddr, regValue8, <span class="hljs-number">1</span>);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="693"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	        <span class="hljs-keyword">if</span>(status==OSA_SOK) {</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="694"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	          status = DRV_i2cRead8(&amp;i2cHndl, regAddr, regValue8, <span class="hljs-number">1</span>);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="695"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	        }        </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="696"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	      }</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="697"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	      <span class="hljs-keyword">else</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="698"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	      <span class="hljs-keyword">if</span>(dataSize==<span class="hljs-number">2</span>) {   </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="699"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	        status = DRV_i2cWrite16(&amp;i2cHndl, regAddr, regValue16, <span class="hljs-number">1</span>);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="700"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	        <span class="hljs-keyword">if</span>(status==OSA_SOK) {</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="701"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	          status = DRV_i2cRead16(&amp;i2cHndl, regAddr, regValue16, <span class="hljs-number">1</span>);        </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="702"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	        }</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="703"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	      }</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="704"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	      </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="705"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	      <span class="hljs-keyword">if</span>(status==OSA_SOK) {</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="706"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	        <span class="hljs-keyword">if</span>(dataSize==<span class="hljs-number">1</span>) {</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="707"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	          OSA_printf(<span class="hljs-string">" I2C: 0x%02x = 0x%02x \n"</span>, regAddr[<span class="hljs-number">0</span>], regValue8[<span class="hljs-number">0</span>] );          </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="708"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	        } <span class="hljs-keyword">else</span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="709"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	        <span class="hljs-keyword">if</span>(dataSize==<span class="hljs-number">2</span>)</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="710"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	          OSA_printf(<span class="hljs-string">" I2C: 0x%02x = 0x%04x \n"</span>, regAddr[<span class="hljs-number">0</span>], regValue16[<span class="hljs-number">0</span>] );                  </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="711"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	      } <span class="hljs-keyword">else</span> {</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="712"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	        OSA_printf(<span class="hljs-string">" I2C: Write ERROR !!!\n"</span>);          </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="713"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	      }</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="714"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	      OSA_printf(<span class="hljs-string">" \n"</span>);                    </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="715"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	      </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="716"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    }</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="717"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    <span class="hljs-meta">#<span class="hljs-meta-keyword">endif</span></span></div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="718"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    </div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="719"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	    DRV_i2cClose(&amp;i2cHndl);</div></div></li><li><div class="hljs-ln-numbers"><div class="hljs-ln-line hljs-ln-n" data-line-number="720"></div></div><div class="hljs-ln-code"><div class="hljs-ln-line">	  }</div></div></li></ol></code><div class="hljs-button {2}" data-title="复制" onclick="hljs.copyCode(event)"></div></pre><br><br>
<p></p>
